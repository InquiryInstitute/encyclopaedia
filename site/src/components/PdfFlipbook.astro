---
/**
 * PDF Flipbook Component
 * 
 * Renders PDFs using PDF.js with a page-flip interface.
 * Falls back to standard PDF download if JS is unavailable.
 */
interface Props {
  pdfUrl: string;
  title: string;
  edition: 'adult' | 'children';
}

const { pdfUrl, title, edition } = Astro.props;
---

<section class="flipbook-container" data-edition={edition}>
  <header class="flipbook-header">
    <h1 class="flipbook-title">{title}</h1>
    <div class="flipbook-controls">
      <button id="prev-page" class="control-btn" aria-label="Previous page">
        ‚Üê Prev
      </button>
      <span id="page-indicator" class="page-indicator">
        Page <span id="current-page">1</span> of <span id="total-pages">?</span>
      </span>
      <button id="next-page" class="control-btn" aria-label="Next page">
        Next ‚Üí
      </button>
    </div>
  </header>
  
  <div id="flipbook-viewport" class="flipbook-viewport">
    <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
    <div id="loading-indicator" class="loading-indicator">
      Loading PDF...
    </div>
  </div>
  
  <noscript>
    <div class="noscript-fallback">
      <p>JavaScript is required for the flipbook viewer.</p>
      <p><a href={pdfUrl} download>Download the PDF</a> to read offline.</p>
    </div>
  </noscript>
  
  <footer class="flipbook-footer">
    <a href={pdfUrl} download class="download-link">
      üì• Download PDF
    </a>
  </footer>
</section>

<script is:inline define:vars={{ pdfUrl }}>
  // PDF.js initialization using CDN
  const PDFJS_VERSION = '4.0.379';
  const PDFJS_CDN = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.min.mjs`;
  const PDFJS_WORKER = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.worker.min.mjs`;
  
  let pdfDoc = null;
  let pageNum = 1;
  let pageRendering = false;
  let pageNumPending = null;
  let scale = 1.0;
  
  const canvas = document.getElementById('pdf-canvas');
  const ctx = canvas.getContext('2d');
  const loadingIndicator = document.getElementById('loading-indicator');
  const currentPageSpan = document.getElementById('current-page');
  const totalPagesSpan = document.getElementById('total-pages');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  
  async function init() {
    try {
      // Load PDF.js from CDN
      const pdfjsLib = await import(PDFJS_CDN);
      pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER;
      
      // Load the PDF
      const loadingTask = pdfjsLib.getDocument(pdfUrl);
      pdfDoc = await loadingTask.promise;
      
      totalPagesSpan.textContent = pdfDoc.numPages;
      loadingIndicator.style.display = 'none';
      
      // Render first page
      renderPage(pageNum);
      
      // Set up controls
      prevBtn.addEventListener('click', onPrevPage);
      nextBtn.addEventListener('click', onNextPage);
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') onPrevPage();
        if (e.key === 'ArrowRight') onNextPage();
      });
      
    } catch (error) {
      console.error('Error loading PDF:', error);
      loadingIndicator.textContent = 'Error loading PDF. Please try the download link below.';
    }
  }
  
  function calculateScale(pageWidth, pageHeight) {
    const viewport = document.getElementById('flipbook-viewport');
    if (!viewport) return 1.0;
    
    const maxWidth = viewport.clientWidth - 40; // Padding
    const maxHeight = viewport.clientHeight - 40;
    
    const widthScale = maxWidth / pageWidth;
    const heightScale = maxHeight / pageHeight;
    
    // Use the smaller scale to fit both dimensions
    return Math.min(widthScale, heightScale, 1.5); // Cap at 1.5x for readability
  }
  
  async function renderPage(num) {
    pageRendering = true;
    
    try {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: 1.0 });
      
      // Calculate optimal scale to fit viewport
      const optimalScale = calculateScale(viewport.width, viewport.height);
      const scaledViewport = page.getViewport({ scale: optimalScale });
      
      canvas.height = scaledViewport.height;
      canvas.width = scaledViewport.width;
      
      const renderContext = {
        canvasContext: ctx,
        viewport: scaledViewport
      };
      
      await page.render(renderContext).promise;
      
      pageRendering = false;
      currentPageSpan.textContent = num;
      
      // Update button states
      prevBtn.disabled = num <= 1;
      nextBtn.disabled = num >= pdfDoc.numPages;
      
      if (pageNumPending !== null) {
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    } catch (error) {
      console.error('Error rendering page:', error);
      pageRendering = false;
    }
  }
  
  // Handle window resize
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (pdfDoc && pageNum) {
        renderPage(pageNum);
      }
    }, 250);
  });
  
  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }
  
  function onPrevPage() {
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
  }
  
  function onNextPage() {
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .flipbook-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .flipbook-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  
  .flipbook-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 1rem;
    color: #c9a227;
  }
  
  .flipbook-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
  }
  
  .control-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #c9a227;
    background: transparent;
    color: #f5f0e6;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .control-btn:hover:not(:disabled) {
    background: #c9a227;
    color: #1a1512;
  }
  
  .control-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  .page-indicator {
    font-size: 0.9rem;
    color: #a89080;
  }
  
  .flipbook-viewport {
    position: relative;
    background: linear-gradient(180deg, #1a1512 0%, #2a1f18 50%, #1a1512 100%);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    margin-bottom: 1.5rem;
    min-height: 600px;
    max-height: 90vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow: auto;
  }
  
  .pdf-canvas {
    max-width: 100%;
    max-height: 100%;
    height: auto;
    width: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    background: #fff;
  }
  
  .loading-indicator {
    position: absolute;
    font-style: italic;
    color: #a89080;
  }
  
  .noscript-fallback {
    padding: 2rem;
    text-align: center;
    color: #f5f0e6;
  }
  
  .noscript-fallback a {
    color: #c9a227;
  }
  
  .flipbook-footer {
    text-align: center;
  }
  
  .download-link {
    color: #c9a227;
    text-decoration: none;
  }
  
  .download-link:hover {
    text-decoration: underline;
  }
  
  [data-edition="children"] .flipbook-title {
    color: #d4b5d4;
  }
</style>
