---
/**
 * PDF Flipbook Component
 * 
 * Renders PDFs using PDF.js with a page-flip interface.
 * Falls back to standard PDF download if JS is unavailable.
 */
interface Props {
  pdfUrl: string;
  title: string;
  edition: 'adult' | 'children';
}

const { pdfUrl, title, edition } = Astro.props;
---

<section class="flipbook-container" data-edition={edition}>
  <header class="flipbook-header">
    <h1 class="flipbook-title">{title}</h1>
    <div class="flipbook-controls">
      <button id="prev-page" class="control-btn" aria-label="Previous page">
        ‚Üê Prev
      </button>
      <span id="page-indicator" class="page-indicator">
        Pages <span id="current-page">1-2</span> of <span id="total-pages">?</span>
      </span>
      <button id="next-page" class="control-btn" aria-label="Next page">
        Next ‚Üí
      </button>
    </div>
  </header>
  
  <div id="flipbook-viewport" class="flipbook-viewport">
    <div id="pageflip-container"></div>
    <div id="loading-indicator" class="loading-indicator">
      Loading PDF...
    </div>
  </div>
  
  <noscript>
    <div class="noscript-fallback">
      <p>JavaScript is required for the flipbook viewer.</p>
      <p><a href={pdfUrl} download>Download the PDF</a> to read offline.</p>
    </div>
  </noscript>
  
  <footer class="flipbook-footer">
    <a href={pdfUrl} download class="download-link">
      üì• Download PDF
    </a>
  </footer>
</section>

<script is:inline define:vars={{ pdfUrl }}>
  // Load PageFlip library from CDN (St.PageFlip)
  // Using the correct CDN URL for st-pageflip
  const PAGEFLIP_CDN = 'https://cdn.jsdelivr.net/npm/st-pageflip@1.0.0/dist/st-pageflip.min.js';
  const PAGEFLIP_CDN_ALT = 'https://unpkg.com/st-pageflip@1.0.0/dist/st-pageflip.min.js';
  
  // PDF.js initialization using CDN
  const PDFJS_VERSION = '4.0.379';
  const PDFJS_CDN = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.min.mjs`;
  const PDFJS_WORKER = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.worker.min.mjs`;
  
  let pdfDoc = null;
  let pageFlip = null;
  let renderedPages = new Map();
  
  const container = document.getElementById('pageflip-container');
  const loadingIndicator = document.getElementById('loading-indicator');
  const currentPageSpan = document.getElementById('current-page');
  const totalPagesSpan = document.getElementById('total-pages');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  
  async function init() {
    try {
      loadingIndicator.textContent = 'Loading PDF...';
      console.log('üìÑ PDF URL:', pdfUrl);
      
      // Load PDF.js from CDN first
      console.log('üì¶ Loading PDF.js from:', PDFJS_CDN);
      const pdfjsLib = await import(PDFJS_CDN);
      pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER;
      console.log('‚úÖ PDF.js loaded');
      
      // Load the PDF
      console.log('üìñ Loading PDF document from:', pdfUrl);
      const loadingTask = pdfjsLib.getDocument({
        url: pdfUrl,
        httpHeaders: {},
        withCredentials: false
      });
      
      // Handle loading progress
      loadingTask.onProgress = (progress) => {
        if (progress.total > 0) {
          const percent = Math.round((progress.loaded / progress.total) * 100);
          console.log(`üì• PDF loading: ${percent}%`);
        }
      };
      
      pdfDoc = await loadingTask.promise;
      console.log('‚úÖ PDF loaded successfully:', pdfDoc.numPages, 'pages');
      
      totalPagesSpan.textContent = pdfDoc.numPages;
      
      loadingIndicator.textContent = 'Loading page flip library...';
      
      // Try to load PageFlip library (with fallback)
      let pageFlipLoaded = false;
      try {
        await loadScript(PAGEFLIP_CDN, PAGEFLIP_CDN_ALT);
        // Check if St.PageFlip is available
        const PageFlipClass = (typeof window !== 'undefined' && window.St && window.St.PageFlip) 
          || (typeof St !== 'undefined' && St.PageFlip);
        
        if (PageFlipClass) {
          pageFlipLoaded = true;
          loadingIndicator.textContent = 'Initializing page flip...';
          await initPageFlip();
          loadingIndicator.style.display = 'none';
          
          // Set up controls
          prevBtn.addEventListener('click', () => {
            if (pageFlip) pageFlip.flipPrev();
          });
          nextBtn.addEventListener('click', () => {
            if (pageFlip) pageFlip.flipNext();
          });
          
          // Keyboard navigation
          document.addEventListener('keydown', (e) => {
            if (!pageFlip) return;
            if (e.key === 'ArrowLeft') pageFlip.flipPrev();
            if (e.key === 'ArrowRight') pageFlip.flipNext();
          });
          return;
        }
      } catch (scriptError) {
        console.warn('PageFlip library failed to load, using simple two-page view:', scriptError);
      }
      
      // Fallback to simple two-page view without PageFlip
      if (!pageFlipLoaded) {
        loadingIndicator.textContent = 'Initializing viewer...';
        await initSimpleTwoPage();
        loadingIndicator.style.display = 'none';
      }
      
    } catch (error) {
      console.error('‚ùå Error loading PDF:', error);
      console.error('Error details:', {
        message: error.message,
        name: error.name,
        stack: error.stack,
        pdfUrl: pdfUrl
      });
      
      // More detailed error message
      let errorMsg = 'Failed to load PDF. ';
      if (error.message) {
        errorMsg += error.message;
      } else if (error.name === 'NetworkError') {
        errorMsg += 'Network error - PDF file may not exist or is inaccessible.';
      } else if (error.name === 'InvalidPDFException') {
        errorMsg += 'Invalid PDF file format.';
      } else {
        errorMsg += 'Please check the console for details.';
      }
      
      loadingIndicator.textContent = errorMsg + ' Please try the download link below.';
      loadingIndicator.style.color = '#ff6b6b';
    }
  }
  
  // Fallback: Simple two-page view without PageFlip library
  async function initSimpleTwoPage() {
    const numPages = pdfDoc.numPages;
    let currentSpread = 1;
    
    const leftCanvas = document.createElement('canvas');
    const rightCanvas = document.createElement('canvas');
    leftCanvas.className = 'pdf-page-canvas';
    rightCanvas.className = 'pdf-page-canvas';
    
    const leftDiv = document.createElement('div');
    const rightDiv = document.createElement('div');
    leftDiv.className = 'page left-page';
    rightDiv.className = 'page right-page';
    leftDiv.appendChild(leftCanvas);
    rightDiv.appendChild(rightCanvas);
    
    container.appendChild(leftDiv);
    container.appendChild(rightDiv);
    
    const ctxLeft = leftCanvas.getContext('2d');
    const ctxRight = rightCanvas.getContext('2d');
    
    async function renderSpread(spreadNum) {
      const leftPageNum = (spreadNum - 1) * 2 + 1;
      const rightPageNum = leftPageNum + 1;
      
      if (leftPageNum <= numPages) {
        const page = await pdfDoc.getPage(leftPageNum);
        const viewport = page.getViewport({ scale: 1.2 });
        leftCanvas.width = viewport.width;
        leftCanvas.height = viewport.height;
        await page.render({ canvasContext: ctxLeft, viewport }).promise;
        leftDiv.style.display = 'block';
      } else {
        leftDiv.style.display = 'none';
      }
      
      if (rightPageNum <= numPages) {
        const page = await pdfDoc.getPage(rightPageNum);
        const viewport = page.getViewport({ scale: 1.2 });
        rightCanvas.width = viewport.width;
        rightCanvas.height = viewport.height;
        await page.render({ canvasContext: ctxRight, viewport }).promise;
        rightDiv.style.display = 'block';
      } else {
        rightDiv.style.display = 'none';
      }
      
      currentPageSpan.textContent = `${leftPageNum}${rightPageNum <= numPages ? '-' + rightPageNum : ''}`;
      prevBtn.disabled = currentSpread <= 1;
      nextBtn.disabled = rightPageNum >= numPages;
    }
    
    prevBtn.addEventListener('click', () => {
      if (currentSpread > 1) {
        currentSpread--;
        renderSpread(currentSpread);
      }
    });
    
    nextBtn.addEventListener('click', () => {
      const rightPageNum = currentSpread * 2;
      if (rightPageNum < numPages) {
        currentSpread++;
        renderSpread(currentSpread);
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' && currentSpread > 1) {
        currentSpread--;
        renderSpread(currentSpread);
      }
      if (e.key === 'ArrowRight') {
        const rightPageNum = currentSpread * 2;
        if (rightPageNum < numPages) {
          currentSpread++;
          renderSpread(currentSpread);
        }
      }
    });
    
    await renderSpread(1);
  }
  
  function loadScript(src, altSrc = null) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = () => {
        if (altSrc) {
          // Try alternative CDN
          const altScript = document.createElement('script');
          altScript.src = altSrc;
          altScript.onload = resolve;
          altScript.onerror = () => reject(new Error(`Failed to load script from ${src} and ${altSrc}`));
          document.head.appendChild(altScript);
        } else {
          reject(new Error(`Failed to load script from ${src}`));
        }
      };
      document.head.appendChild(script);
    });
  }
  
  async function initPageFlip() {
    const numPages = pdfDoc.numPages;
    const pages = [];
    
    // Create page elements
    for (let i = 0; i < numPages; i++) {
      const pageDiv = document.createElement('div');
      pageDiv.className = 'page';
      pageDiv.dataset.pageNum = i + 1;
      
      const canvas = document.createElement('canvas');
      canvas.className = 'pdf-page-canvas';
      pageDiv.appendChild(canvas);
      
      pages.push(pageDiv);
      container.appendChild(pageDiv);
    }
    
    // Initialize PageFlip
    pageFlip = new St.PageFlip(container, {
      width: 600,
      height: 800,
      showCover: false,
      maxShadowOpacity: 0.5,
      drawShadow: true,
      flippingTime: 1000,
      usePortrait: true,
      startPage: 0,
      size: 'stretch',
      minWidth: 300,
      maxWidth: 1200,
      minHeight: 400,
      maxHeight: 1600,
    });
    
    // Render pages as needed
    pageFlip.on('flip', (e) => {
      const currentPage = e.data + 1;
      currentPageSpan.textContent = `${currentPage}${currentPage < numPages ? '-' + (currentPage + 1) : ''}`;
      
      // Render current and adjacent pages
      renderPageIfNeeded(currentPage);
      if (currentPage < numPages) renderPageIfNeeded(currentPage + 1);
      if (currentPage > 1) renderPageIfNeeded(currentPage - 1);
    });
    
    // Initial render
    renderPageIfNeeded(1);
    if (numPages > 1) renderPageIfNeeded(2);
    
    // Update button states
    pageFlip.on('flip', () => {
      prevBtn.disabled = pageFlip.getCurrentPageIndex() === 0;
      nextBtn.disabled = pageFlip.getCurrentPageIndex() >= numPages - 1;
    });
    
    // Calculate size based on viewport
    updatePageFlipSize();
    window.addEventListener('resize', () => {
      updatePageFlipSize();
    });
  }
  
  function updatePageFlipSize() {
    if (!pageFlip) return;
    
    const viewport = document.getElementById('flipbook-viewport');
    const maxWidth = viewport.clientWidth - 40;
    const maxHeight = viewport.clientHeight - 40;
    
    // Maintain aspect ratio (A4 is roughly 1.414:1)
    let width = Math.min(maxWidth, maxHeight * 1.414);
    let height = width / 1.414;
    
    if (height > maxHeight) {
      height = maxHeight;
      width = height * 1.414;
    }
    
    pageFlip.update();
  }
  
  async function renderPageIfNeeded(pageNum) {
    if (renderedPages.has(pageNum)) return;
    
    const pageElement = container.querySelector(`[data-page-num="${pageNum}"]`);
    if (!pageElement) return;
    
    const canvas = pageElement.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    
    try {
      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1.0 });
      
      // Calculate scale to fit page element
      const pageRect = pageElement.getBoundingClientRect();
      const scale = Math.min(
        (pageRect.width - 20) / viewport.width,
        (pageRect.height - 20) / viewport.height,
        2.0
      );
      
      const scaledViewport = page.getViewport({ scale });
      
      canvas.height = scaledViewport.height;
      canvas.width = scaledViewport.width;
      
      await page.render({
        canvasContext: ctx,
        viewport: scaledViewport
      }).promise;
      
      renderedPages.set(pageNum, true);
    } catch (error) {
      console.error(`Error rendering page ${pageNum}:`, error);
    }
  }
  
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .flipbook-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .flipbook-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  
  .flipbook-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 1rem;
    color: #c9a227;
  }
  
  .flipbook-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
  }
  
  .control-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #c9a227;
    background: transparent;
    color: #f5f0e6;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .control-btn:hover:not(:disabled) {
    background: #c9a227;
    color: #1a1512;
  }
  
  .control-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  .page-indicator {
    font-size: 0.9rem;
    color: #a89080;
  }
  
  .flipbook-viewport {
    position: relative;
    background: linear-gradient(180deg, #1a1512 0%, #2a1f18 50%, #1a1512 100%);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    margin-bottom: 1.5rem;
    min-height: 600px;
    max-height: 90vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow: hidden;
  }
  
  #pageflip-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .page {
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    box-sizing: border-box;
  }
  
  .pdf-page-canvas {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    display: block;
  }
  
  .loading-indicator {
    position: absolute;
    font-style: italic;
    color: #a89080;
  }
  
  .noscript-fallback {
    padding: 2rem;
    text-align: center;
    color: #f5f0e6;
  }
  
  .noscript-fallback a {
    color: #c9a227;
  }
  
  .flipbook-footer {
    text-align: center;
  }
  
  .download-link {
    color: #c9a227;
    text-decoration: none;
  }
  
  .download-link:hover {
    text-decoration: underline;
  }
  
  [data-edition="children"] .flipbook-title {
    color: #d4b5d4;
  }
</style>
